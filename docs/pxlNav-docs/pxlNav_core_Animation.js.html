<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>pxlNav/core/Animation.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://procstack.github.io/Outlet.htm" target="_blank" class="menu-item" id="pxlNav_Example" >pxlNav Example : The Outlet</a></h2><h3>Global</h3><ul><li><a href="global.html##pxlEnums">#pxlEnums</a></li><li><a href="global.html#pxlOptions">pxlOptions</a></li><li><a href="global.html#pxlUserSettings">pxlUserSettings</a></li></ul><h3>Modules</h3><ul><li><a href="module-pxlNav.html">pxlNav</a></li><li><a href="pxlNav.module_pxlEffects.html">pxlNav.pxlEffects</a></li><li><a href="pxlNav.pxlEffects.module_pxlParticles.html">pxlNav.pxlEffects.pxlParticles</a></li></ul><h3>Classes</h3><ul><li><a href="pxlAnim.html">pxlAnim</a><ul class='methods'><li data-type='method'><a href="pxlAnim.html#.Animation#addClips">Animation#addClips</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#destroy">Animation#destroy</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#getMesh">Animation#getMesh</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#getMixer">Animation#getMixer</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#getRig">Animation#getRig</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#hasClip">Animation#hasClip</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#initObject">Animation#initObject</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#playClip">Animation#playClip</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#setStateConnections">Animation#setStateConnections</a></li><li data-type='method'><a href="pxlAnim.html#.Animation#setWeight">Animation#setWeight</a></li></ul></li><li><a href="pxlCamera.html">pxlCamera</a><ul class='methods'><li data-type='method'><a href="pxlCamera.html#.Camera#setCameraRotateEasing">Camera#setCameraRotateEasing</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setGravityMax">Camera#setGravityMax</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setGravityRate">Camera#setGravityRate</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setInputMovementMult">Camera#setInputMovementMult</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setJumpHoldMax">Camera#setJumpHoldMax</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setJumpImpulse">Camera#setJumpImpulse</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setJumpRepeatDelay">Camera#setJumpRepeatDelay</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setJumpScalar">Camera#setJumpScalar</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setMaxStepHeight">Camera#setMaxStepHeight</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setMovementEase">Camera#setMovementEase</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setMovementMax">Camera#setMovementMax</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setMovementScalar">Camera#setMovementScalar</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setPositionBlend">Camera#setPositionBlend</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setTouchSensitivity">Camera#setTouchSensitivity</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setUserHeight">Camera#setUserHeight</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setUserScale">Camera#setUserScale</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setUserSettings">Camera#setUserSettings</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setWalkBounceEaseIn">Camera#setWalkBounceEaseIn</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setWalkBounceEaseOut">Camera#setWalkBounceEaseOut</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setWalkBounceHeight">Camera#setWalkBounceHeight</a></li><li data-type='method'><a href="pxlCamera.html#.Camera#setWalkBounceRate">Camera#setWalkBounceRate</a></li></ul></li><li><a href="pxlEnums.html">pxlEnums</a><ul class='methods'><li data-type='method'><a href="pxlEnums.html#.ANTI_ALIASING">ANTI_ALIASING</a></li><li data-type='method'><a href="pxlEnums.html#.CAMERA_EVENT">CAMERA_EVENT</a></li><li data-type='method'><a href="pxlEnums.html#.COLLIDER_TYPE">COLLIDER_TYPE</a></li><li data-type='method'><a href="pxlEnums.html#.COLOR_SHIFT">COLOR_SHIFT</a></li><li data-type='method'><a href="pxlEnums.html#.DEVICE_ACTION">DEVICE_ACTION</a></li><li data-type='method'><a href="pxlEnums.html#.DEVICE_EVENT">DEVICE_EVENT</a></li><li data-type='method'><a href="pxlEnums.html#.DEVICE_TYPE">DEVICE_TYPE</a></li><li data-type='method'><a href="pxlEnums.html#.GEOMETRY_SIDE">GEOMETRY_SIDE</a></li><li data-type='method'><a href="pxlEnums.html#.HUD_ACTION">HUD_ACTION</a></li><li data-type='method'><a href="pxlEnums.html#.HUD_ELEMENT">HUD_ELEMENT</a></li><li data-type='method'><a href="pxlEnums.html#.RENDER_LAYER">RENDER_LAYER</a></li><li data-type='method'><a href="pxlEnums.html#.SHADOW_MAP">SHADOW_MAP</a></li><li data-type='method'><a href="pxlEnums.html#.SKY_HAZE">SKY_HAZE</a></li><li data-type='method'><a href="pxlEnums.html#.USER_SPEED">USER_SPEED</a></li><li data-type='method'><a href="pxlEnums.html#.VERBOSE_LEVEL">VERBOSE_LEVEL</a></li></ul></li><li><a href="pxlHUD.html">pxlHUD</a><ul class='methods'><li data-type='method'><a href="pxlHUD.html#.HUD#addItem">HUD#addItem</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#addToHUD">HUD#addToHUD</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#createButton">HUD#createButton</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#createDragRegion">HUD#createDragRegion</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#createImage">HUD#createImage</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#createRegion">HUD#createRegion</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#createSlider">HUD#createSlider</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#createText">HUD#createText</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#createThumbstick">HUD#createThumbstick</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#emit">HUD#emit</a></li><li data-type='method'><a href="pxlHUD.html#.HUD#subscribe">HUD#subscribe</a></li></ul></li><li><a href="pxlParticles_BillowSmoke.html">pxlParticles/BillowSmoke</a><ul class='methods'><li data-type='method'><a href="pxlParticles_BillowSmoke.html#.BillowSmoke#build">BillowSmoke#build</a></li></ul></li><li><a href="pxlParticles_EmberWisps.html">pxlParticles/EmberWisps</a><ul class='methods'><li data-type='method'><a href="pxlParticles_EmberWisps.html#.EmberWisps#build">EmberWisps#build</a></li></ul></li><li><a href="pxlParticles_FloatingDust.html">pxlParticles/FloatingDust</a><ul class='methods'><li data-type='method'><a href="pxlParticles_FloatingDust.html#.FloatingDust#build">FloatingDust#build</a></li></ul></li><li><a href="pxlParticles_HeightMap.html">pxlParticles/HeightMap</a><ul class='methods'><li data-type='method'><a href="pxlParticles_HeightMap.html#.HeightMap#build">HeightMap#build</a></li><li data-type='method'><a href="pxlParticles_HeightMap.html#.HeightMap#setHeightMapPath">HeightMap#setHeightMapPath</a></li><li data-type='method'><a href="pxlParticles_HeightMap.html#.HeightMap#setSpawnMapPath">HeightMap#setSpawnMapPath</a></li></ul></li><li><a href="pxlParticles_ParticleBase.html">pxlParticles/ParticleBase</a><ul class='methods'><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#addToScene">ParticleBase#addToScene</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#atlasArrayPicker">ParticleBase#atlasArrayPicker</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#atlasRandomGen">ParticleBase#atlasRandomGen</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#atlasRandomList">ParticleBase#atlasRandomList</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#dupeArray">ParticleBase#dupeArray</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#elementDuplicator">ParticleBase#elementDuplicator</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#getSettings">ParticleBase#getSettings</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#hasPointLights">ParticleBase#hasPointLights</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#newMaterial">ParticleBase#newMaterial</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#setAtlasPath">ParticleBase#setAtlasPath</a></li><li data-type='method'><a href="pxlParticles_ParticleBase.html#.ParticleBase#setPosition">ParticleBase#setPosition</a></li></ul></li><li><a href="pxlRoom%2520RoomEnvironment.html">pxlRoom RoomEnvironment</a><ul class='methods'><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#addColliderHelper">addColliderHelper</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#animPostLoad">animPostLoad</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#applyRoomPass">applyRoomPass</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#build">build</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#castRay">castRay</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#cleanupPortalRender">cleanupPortalRender</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#fbxPostLoad">fbxPostLoad</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#getArtistInfo">getArtistInfo</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#getColliders">getColliders</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#getCurrentShader">getCurrentShader</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#getLerpAvgRate">getLerpAvgRate</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#getLerpRate">getLerpRate</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#getName">getName</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#getShaderList">getShaderList</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#hasColliderType">hasColliderType</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#hasColliders">hasColliders</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#hitColliders">hitColliders</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#init">init</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#onMessage">onMessage</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#prepPortalRender">prepPortalRender</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#readShader">readShader</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#resetCamera">resetCamera</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#resize">resize</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#setDependencies">setDependencies</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#setFog">setFog</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#setPortalTexture">setPortalTexture</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#setShader">setShader</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#setUserHeight">setUserHeight</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#start">start</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#step">step</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#stepColliderHelper">stepColliderHelper</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#stop">stop</a></li><li data-type='method'><a href="pxlRoom%252520RoomEnvironment.html#toCameraPos">toCameraPos</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="pxlAudio.html">pxlAudio</a></li><li><a href="pxlAutoCam.html">pxlAutoCam</a></li><li><a href="pxlColliders.html">pxlColliders</a></li><li><a href="pxlCookie.html">pxlCookie</a></li><li><a href="pxlDevice.html">pxlDevice</a></li><li><a href="pxlEnv.html">pxlEnv</a></li><li><a href="pxlFile.html">pxlFile</a></li><li><a href="pxlGuiDraws.html">pxlGuiDraws</a></li><li><a href="pxlQuality.html">pxlQuality</a></li><li><a href="pxlTimer.html">pxlTimer</a></li><li><a href="pxlUser.html">pxlUser</a></li><li><a href="pxlUtils.html">pxlUtils</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">pxlNav/core/Animation.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// pxlNav Animation Manager
// -- -- -- -- -- -- -- -- --
// Written by Kevin Edzenga; 2024


import {
  Clock,
  AnimationMixer,
  MeshStandardMaterial,
} from "../../libs/three/three.module.min.js";

/**
 * @alias pxlAnim
 * @class
 * @description Animation handling
 */
export class Animation{
  constructor( assetPath=null, msRunner=null ){
    this.pxlEnv = null;
    this.assetPath=assetPath;
    this.verbose = false;
    
    this.animInitEntry = {
      'rig' : null,
      'mesh' : null,
      'mixer' : null,
      'clips' : {},

      'state' : null,
      'hasConnection' : false,
      'prevTime' : -1,
      'connected' : [],
      'connections' : {}
    }
    
    this.objNames = [];
    this.objects = {};
    this.animMixer = {};
    this.msRunner=msRunner;
    this.clock = new Clock();
  }
  setDependencies( pxlEnv ){
    this.pxlEnv = pxlEnv;
  }
  log( msg ){
    if( this.verbose ){
      console.log( msg );
    }
  }

  /**
   * Initialize an object for animation
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @param {Object} animFbx - The FBX object to animate
   */
  initObject( animName, animFbx ){
    
    let animRoot = null;
    let bindObj = null;
    let runCount = animFbx.children.length;
    let x = 0;
    let checkList = [...animFbx.children];
    let meshCount = 0;
    let boneCount = 0;
    let SkinnedMeshCount = 0;
    let GroupCount = 0;
    while( x &lt; runCount ){
      let c = checkList[x];
      switch( c.type ){
        case "Bone":
          ++boneCount;
          animRoot = c;
          break;
        case "Mesh":
          ++meshCount;
          c.visible = false;
          break;
        case "SkinnedMesh":
          ++SkinnedMeshCount;
          bindObj = c;
          break;
        case "Group":
          ++GroupCount;
          checkList = checkList.concat( c.children );
          runCount = checkList.length;
          break;
        default:
          break;
      }
      ++x;
    }

    let error = false;
    if( !animRoot ){
      this.log("Error, No Bone/Rig Root Found; Please move your rig to the scene's root. Grouped rigs aren't supported yet.");
      error = true;
    }
    if( !bindObj ){
      this.log("Error, No SkinnedMesh Found; Please ensure your rig has a mesh to animate.");
      error = true;
    }
    if( error ){
      console.log( "Unable to prepare '"+animName+"' for animation" );

      console.log( "Group Count: "+GroupCount );
      console.log( "Bone Root Found : "+(boneCount>0) );
      console.log( "Bone Count : "+boneCount );
      console.log( "Mesh Count: "+meshCount );
      console.log( "SkinnedMesh Count: "+SkinnedMeshCount );
      return;
    }


    //console.log( animFbx)

    if( !this.objNames.includes( animName ) ){
      this.objNames.push( animName );
      let outDict = Object.assign({}, this.animInitEntry);
      outDict[ 'rig' ] = animRoot;
      outDict[ 'mesh' ] = bindObj;
      this.animMixer[ animName ] = new AnimationMixer( animRoot );
      outDict[ 'mixer' ] = this.animMixer[ animName ];
      this.objects[ animName ] = outDict;

      let skinnedMaterial = new MeshStandardMaterial();
      skinnedMaterial.map = bindObj.material.map;

      bindObj.material = skinnedMaterial;
    }
  }
  
  /**
   * Add a clip to an object
   *   Use `pxlFile.loadAnimFBX() to load your animation clips`
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @param {string} clipName - The name of the clip to add
   * @param {Object} animFbx - The FBX object to animate
   * @example
   * // Add a clip to an object
   * pxlAnim.addClips( "myAnim", "myClip", fbxLoader_animationCycleRoot );
   */
  addClips( animName, clipName, animFbx ){
    if( !this.objNames.includes( animName ) ){
      this.log("Error, '"+animName+"' not found in Animation Manager");
      return;
    }
    let clipNames = Object.keys( this.objects[ animName ][ 'clips' ] );
    if( clipNames.includes( clipName ) ){
      this.log("Warning, '"+clipName+"' already exists in '"+animName+"'");
    }
    let animMixer = this.animMixer[ animName ];
    //console.log(animFbx.animations);

    // TODO : Add support for objects to reuse animation sources

    let newClip = animMixer.clipAction( animFbx.animations[0] );
    this.objects[ animName ][ 'clips' ][ clipName ] = newClip;

  }


  /**
   * Check if an object has a clip
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @param {string} clipName - The name of the clip to check for
   * @returns {boolean} - True if the object has the clip
   * @example
   * // Check if an object has a clip
   * let hasClip = this.pxlAnim.hasClip( this.animRigName, "myClipName" );
   * console.log( hasClip );
   */
  hasClip( animName, clipName ){
    if( this.objNames.includes( animName ) ){
      let clipNames = Object.keys( this.objects[ animName ][ 'clips' ] );
      return clipNames.includes( clipName );
    }
    return false;
  }

  /**
   * Get the current state of an object
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @returns {string} - The current state of the object
   * @example
   * // Get the current state of an object
   * let curState = this.pxlAnim.getMixer( this.animRigName );
   * console.log( curState );
   */
  getMixer( animName ){
    if( this.objNames.includes( animName ) ){
      return this.animMixer[ animName ];
    }
    return null;
  }

  /**
   * Get animation rig of an object
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @returns {Object} - The rig object of the animation object
   * @example
   * // Get animation rig of an object
   * let rig = this.pxlAnim.getRig( this.animRigName );
   * console.log( rig );
   */
  getRig( animName ){
    if( this.objNames.includes( animName ) ){
      return this.objects[ animName ][ 'rig' ];
    }
    return null;
  }

  /**
   * Get mesh of the rigged object
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @returns {Object} - The mesh object of the animation object
   * @example
   * // Get mesh of the rigged object
   * let mesh = this.pxlAnim.getMesh( this.animRigName );
   * console.log( mesh );
   */
  getMesh( animName ){
    if( this.objNames.includes( animName ) ){
      return this.objects[ animName ][ 'mesh' ];
    }
    return null;
  }

  /**
   * Play a clip on an object
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @param {string} clipName - The name of the clip to play
   * @example
   * // Play a clip on an object
   * this.pxlAnim.playClip( this.animRigName, "myClipName" );
   */
  playClip( animName, clipName ){
    if( this.objNames.includes( animName ) ){
      let clipNames = Object.keys( this.objects[ animName ][ 'clips' ] );
      if( clipNames.includes( clipName ) ){
        let clip = this.objects[ animName ][ 'clips' ][ clipName ];
        this.objects[ animName ][ 'state' ] = clipName ;
        this.objects[ animName ][ 'prevTime' ] = -1 ;
        this.objects[ animName ][ 'hasConnection' ] = this.objects[ animName ][ 'connected' ].includes( clipName );

        this.setWeight( animName, clipName, 1, true );

        clip.reset();
        clip.play();
      }
    }
  }
  /**
   * Set blend weights of animation cycle in the mixer
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @param {string} clipName - The name of the clip to set weight for
   * @param {number} weight - The weight to set
   * @param {boolean} disableOthers - Disable other clips in the mixer
   * @example
   * // Set blend weights of animation cycle in the mixer
   * //this.pxlAnim.setWeight( this.animRigName, "myClipName", 1, true );
   * this.pxlAnim.setWeight( this.animRigName, "myClipName", 0.5, false );
   * //this.pxlAnim.setWeight( this.animRigName, "myClipName", 0.25, true );
   */
  setWeight( animName, clipName, weight, disableOthers=false ){
    if( this.objNames.includes( animName ) ){
      let clipNames = Object.keys( this.objects[ animName ][ 'clips' ] );
      if( clipNames.includes( clipName ) ){
        let clip = this.objects[ animName ][ 'clips' ][ clipName ];
        clip.enabled = true;
        clip.setEffectiveTimeScale( 1 );
        clip.setEffectiveWeight( weight );
        if( disableOthers ){
          clipNames.forEach( (clipKey)=>{
            if( clipKey != clipName ){
              let nonClip = this.objects[ animName ][ 'clips' ][ clipKey ];
              nonClip.enabled = false;
              nonClip.setEffectiveTimeScale( 1 );
              nonClip.setEffectiveWeight( 0 );
            }
          });
        }
      }
    }
  }

  /**
   * Set animation cycle speed in the mixer
   * 
   * This is handled when the FBX is loaded, this is visible for the example
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @param {string} clipName - The name of the clip to set speed for
   * @param {number} speed - The speed to set
   * @example
   * // Set animation cycle speed in the mixer
   * constructor(){
   *     this.animSource = {
   *       "RabbitDruidA" : {
   *         "rig" : this.assetPath+"RabbitDruidA/RabbitDruidA_rig.fbx",
   *         "anim" : {
   *           "Sit_Idle" : this.assetPath+"RabbitDruidA/RabbidDruidA_anim_sit_idle.fbx",
   *           "Sit_Stoke" : this.assetPath+"RabbitDruidA/RabbidDruidA_anim_sit_stoke.fbx",
   *           "Sit_Look" : this.assetPath+"RabbitDruidA/RabbidDruidA_anim_sit_look.fbx"
   *         },
   *         "stateConnections"  : {
   *           // Non existing states will be ignored and loop'ed, ie "Walk"
   *           "Sit_Idle" : [ ...Array(6).fill("Sit_Idle"), ...Array(6).fill("Sit_Stoke"), ...Array(5).fill("Sit_Look")],
   *           "Sit_Stoke" : ["Sit_Idle"],
   *           "Sit_Look" : ["Sit_Idle"]
   *         }
   *       }
   *     };
   *   }
   */
  setStateConnections( animName, stateConnections ){
    if( this.objNames.includes( animName ) ){
      let stateKeys = Object.keys( stateConnections );
      this.objects[ animName ][ 'connected' ] = stateKeys;
      this.objects[ animName ][ 'connections' ] = stateConnections;
    }
  }

  // -- -- --
  
  // Rudimentary State Machine Implementation
  // If the current state has 'connections',
  //   It'll random pick form those possible states
  // If no outgoing connections, it'll loop the current state
  step( animName ){
    if( this.objNames.includes( animName ) ){
      let hasConnection = this.objects[ animName ][ 'hasConnection' ];
      if( !hasConnection ){
        this.animMixer[ animName ].update( this.clock.getDelta() );
        return;
      }

      let curState = this.objects[ animName ][ 'state' ];
      if( curState ){ // Dunno why this would never be set when 'hasConnection' is set, sanity check
        let curClip = this.objects[ animName ][ 'clips' ][ curState ];
        let curTime = curClip.time;
        let prevTime = this.objects[ animName ][ 'prevTime' ];

        // Cycle loop check
        if( prevTime > curTime ){
          let nextStates = this.objects[ animName ][ 'connections' ][ curState ];
          let randState = nextStates[ Math.floor( Math.random() * nextStates.length ) ];
          this.playClip( animName, randState );
        }else{
          this.animMixer[ animName ].update( this.clock.getDelta() );
          this.objects[ animName ][ 'prevTime' ] = curTime;
        }
      }else{
        this.animMixer[ animName ].update( this.clock.getDelta() );
      }
    }
  }

  // -- -- -- 

  /**
   * Destroy a rig + animation objects of the provided animation name
   * @method
   * @memberof pxlAnim
   * @param {string} animName - The name of the animation object
   * @example
   * // Destroy a rig + animation objects of the provided animation name
   * this.pxlAnim.destroy( "myAnim" );
   */
  destroy( animName ){
    if( this.objNames.includes( animName ) ){
      this.animMixer[ animName ].stopAllAction();
      delete this.animMixer[ animName ];
      delete this.objects[ animName ];
      let idx = this.objNames.indexOf( animName );
      this.objNames.splice( idx, 1 );
    }
  }

}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Wed Mar 05 2025 09:06:53 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <script src="https://unpkg.com/mermaid/dist/mermaid.js"></script>
    
    <script src="docs-init.js"></script>
    
</body>
</html>
